---
name: dev-quality-gate
description: 多指标质量门禁。综合评估测试覆盖率、AI审查、编译状态、代码规范、方案对齐，决定是否可以继续下一阶段。
---

# 质量门禁 (Quality Gate)

> 综合多个指标评估代码质量，作为阶段间的质量关卡

---

## 核心职责

1. **收集指标**: 从各个来源收集质量指标
2. **加权评分**: 按权重计算综合评分
3. **判定结果**: 通过/警告/阻断
4. **生成报告**: 输出详细的门禁检查报告

---

## 检查指标

| 指标 | 权重 | 阈值 | 检查方式 |
|------|------|------|----------|
| 测试覆盖率 | 30% | ≥70% | 运行测试并统计 |
| AI审查通过 | 25% | 无红色 | dev-ai-review 结果 |
| 编译通过 | 20% | 100% | mvn compile |
| 代码规范 | 15% | ≤5警告 | checkstyle/spotless |
| 方案对齐 | 10% | ≥80% | 对比技术方案 |

---

## 执行流程

```
触发质量门禁
     ↓
┌─────────────────────────────────────┐
│ 1. 编译检查                          │
│    - mvn compile -q                  │
│    - 记录编译结果                    │
└─────────────────────────────────────┘
     ↓
┌─────────────────────────────────────┐
│ 2. 测试覆盖率检查                    │
│    - mvn test jacoco:report         │
│    - 提取覆盖率数值                  │
└─────────────────────────────────────┘
     ↓
┌─────────────────────────────────────┐
│ 3. AI审查结果检查                    │
│    - 读取 dev-ai-review 结果         │
│    - 检查是否有红色项                │
└─────────────────────────────────────┘
     ↓
┌─────────────────────────────────────┐
│ 4. 代码规范检查                      │
│    - 检查警告数量                    │
│    - 检查错误数量                    │
└─────────────────────────────────────┘
     ↓
┌─────────────────────────────────────┐
│ 5. 方案对齐检查                      │
│    - 对比技术方案与实现              │
│    - 计算对齐度                      │
└─────────────────────────────────────┘
     ↓
┌─────────────────────────────────────┐
│ 6. 综合评分                          │
│    - 各指标得分 × 权重               │
│    - 计算总分                        │
│    - 判定结果                        │
└─────────────────────────────────────┘
```

---

## 评分规则

### 测试覆盖率 (30%)

| 覆盖率 | 得分 |
|--------|------|
| ≥80% | 30分 |
| 70-79% | 25分 |
| 60-69% | 20分 |
| 50-59% | 15分 |
| <50% | 0分 |

### AI审查通过 (25%)

| 结果 | 得分 |
|------|------|
| 全部通过 | 25分 |
| 仅警告 | 20分 |
| 有红色项 | 0分 |

### 编译通过 (20%)

| 结果 | 得分 |
|------|------|
| 编译成功 | 20分 |
| 编译失败 | 0分 |

### 代码规范 (15%)

| 警告数 | 得分 |
|--------|------|
| 0 | 15分 |
| 1-5 | 12分 |
| 6-10 | 8分 |
| >10 | 0分 |

### 方案对齐 (10%)

| 对齐度 | 得分 |
|--------|------|
| ≥90% | 10分 |
| 80-89% | 8分 |
| 70-79% | 5分 |
| <70% | 0分 |

---

## 综合评分判定

```
总分 = Σ(指标得分)

┌──────────────┬────────────┬────────────────────────┐
│    总分      │   结果     │        说明            │
├──────────────┼────────────┼────────────────────────┤
│   ≥80分      │  ✅ 通过   │  质量达标，可以继续    │
│   60-79分    │  ⚠️ 警告   │  建议修复后继续        │
│   <60分      │  ❌ 阻断   │  必须修复才能继续      │
└──────────────┴────────────┴────────────────────────┘
```

---

## 门禁位置

根据任务级别，门禁执行的位置不同：

### L1 简单流程
```
快速分析 → 快速实现 → [门禁] → 快速收尾
                        ↑
                   仅1次门禁检查
```

### L2 中等流程
```
需求分析 → 技术分析+方案 → [门禁1] → 编码计划 → 编码+测试 → [门禁2] → 对齐+文档
                            ↑                                    ↑
                       确认点1前                             确认点2前
```

### L3 复杂流程
```
每阶段完成后均执行门禁检查
```

---

## 输出格式

```
┌─────────────────────────────────────────────────────────────┐
│  🚦 质量门禁检查                                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  检查时间: 2026-02-09 11:45                                  │
│  检查阶段: 编码+测试 (4/5)                                   │
│                                                              │
│  ═══ 指标检查 ═══                                           │
│                                                              │
│  测试覆盖率    78%   ✅ (≥70%)              [25分/30分]      │
│  AI审查        通过  ✅ (无红色)             [25分/25分]      │
│  编译状态      成功  ✅                      [20分/20分]      │
│  代码规范      3警告 ✅ (≤5)                [12分/15分]      │
│  方案对齐      85%   ✅ (≥80%)              [ 8分/10分]      │
│                                                              │
│  ═══ 综合评分 ═══                                           │
│                                                              │
│  总分: 90/100                                                │
│                                                              │
│  ████████████████████░░ 90%                                 │
│                                                              │
│  结果: ✅ 通过                                               │
│                                                              │
│  [继续下一阶段] [查看详情]                                  │
└─────────────────────────────────────────────────────────────┘
```

### 警告状态输出

```
┌─────────────────────────────────────────────────────────────┐
│  🚦 质量门禁检查                                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ═══ 指标检查 ═══                                           │
│                                                              │
│  测试覆盖率    62%   ⚠️ (低于70%)           [20分/30分]      │
│  AI审查        警告  ⚠️ (有2个警告)          [20分/25分]      │
│  编译状态      成功  ✅                      [20分/20分]      │
│  代码规范      8警告 ⚠️ (超过5个)            [ 8分/15分]      │
│  方案对齐      75%   ⚠️ (低于80%)            [ 5分/10分]      │
│                                                              │
│  ═══ 综合评分 ═══                                           │
│                                                              │
│  总分: 73/100                                                │
│                                                              │
│  ██████████████░░░░░░ 73%                                   │
│                                                              │
│  结果: ⚠️ 警告                                               │
│                                                              │
│  建议修复:                                                   │
│  ├── 增加测试用例，提高覆盖率至70%                          │
│  ├── 修复AI审查中的警告                                     │
│  └── 减少代码规范警告数量                                   │
│                                                              │
│  [修复后重检] [强制继续] [查看详情]                         │
└─────────────────────────────────────────────────────────────┘
```

### 阻断状态输出

```
┌─────────────────────────────────────────────────────────────┐
│  🚦 质量门禁检查                                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ═══ 指标检查 ═══                                           │
│                                                              │
│  测试覆盖率    45%   ❌ (低于50%)           [ 0分/30分]      │
│  AI审查        阻断  ❌ (有红色项)           [ 0分/25分]      │
│  编译状态      失败  ❌                      [ 0分/20分]      │
│  代码规范      -     ⏸ (编译失败跳过)       [ 0分/15分]      │
│  方案对齐      -     ⏸ (编译失败跳过)       [ 0分/10分]      │
│                                                              │
│  ═══ 综合评分 ═══                                           │
│                                                              │
│  总分: 0/100                                                 │
│                                                              │
│  ░░░░░░░░░░░░░░░░░░░░ 0%                                    │
│                                                              │
│  结果: ❌ 阻断                                               │
│                                                              │
│  必须修复:                                                   │
│  ├── 修复编译错误                                           │
│  ├── 修复AI审查中的红色项                                   │
│  └── 增加测试用例                                           │
│                                                              │
│  ⚠️ 无法继续下一阶段，必须修复以上问题                      │
│                                                              │
│  [修复后重检] [查看详情]                                    │
└─────────────────────────────────────────────────────────────┘
```

---

## 使用方式

### 自动触发

在 `dev-next` 中，确认点前自动触发：

```
/dev-next
     ↓
检测到确认点
     ↓
自动执行 /dev-quality-gate
     ↓
通过 → 显示确认提示
警告 → 显示建议，允许继续
阻断 → 必须修复，不能继续
```

### 手动触发

```
/dev-quality-gate
```

对当前需求执行质量门禁检查。

---

## 与其他skill的协作

| Skill | 协作方式 |
|-------|----------|
| dev-ai-review | 获取AI审查结果 |
| dev-next | 确认点前自动调用门禁 |
| dev-context-loader | 获取技术方案用于对齐检查 |
| dev-impl-test | 编码+测试后触发门禁 |
| dev-finish | 门禁通过后执行收尾 |

---

## 门禁结果存档

门禁结果记录在 `.progress.json`:

```json
{
  "stages": [
    {
      "stage": 4,
      "name": "编码+测试",
      "qualityGate": {
        "checkedAt": "2026-02-09T11:45:00",
        "result": "pass",
        "score": 90,
        "details": {
          "testCoverage": { "value": 78, "score": 25, "max": 30 },
          "aiReview": { "value": "pass", "score": 25, "max": 25 },
          "compile": { "value": "success", "score": 20, "max": 20 },
          "codeStyle": { "value": 3, "score": 12, "max": 15 },
          "alignment": { "value": 85, "score": 8, "max": 10 }
        }
      }
    }
  ],
  "metrics": {
    "qualityGateHistory": [
      { "stage": 2, "score": 85, "result": "pass" },
      { "stage": 4, "score": 90, "result": "pass" }
    ]
  }
}
```

---

## 快速跳过（紧急情况）

在紧急情况下，可以使用 `--force` 参数强制跳过门禁：

```
/dev-next --force
```

跳过门禁时会记录在 `.progress.json`:

```json
{
  "qualityGate": {
    "result": "skipped",
    "reason": "force flag",
    "skippedAt": "2026-02-09T11:50:00"
  }
}
```

⚠️ **警告**: 强制跳过会在最终报告中标记为风险项。

---

## 门禁优化建议

### 提高测试覆盖率
- 使用TDD方法开发
- 添加边界条件测试
- 添加异常场景测试

### 提高方案对齐度
- 严格按照技术方案实现
- 偏差需记录在 decisions[]
- 定期检查对齐度

### 减少代码规范警告
- 使用IDE自动格式化
- 提交前运行检查
- 配置pre-commit hooks
