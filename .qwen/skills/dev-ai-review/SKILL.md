---
name: dev-ai-review
description: AI生成代码专项审查。5维度审查：业务逻辑、架构一致性、代码规范、安全检查、测试充分性。编码阶段自动触发。
---

# AI代码专项审查 (AI Code Review)

> 针对AI生成代码的5维度专项审查，确保代码质量和业务准确性

---

## 核心职责

审查AI生成的代码，从5个维度确保质量：

1. **业务逻辑正确性**: 是否符合需求分析中的业务规则
2. **架构一致性**: 是否与技术方案一致，是否遵循现有模式
3. **代码规范符合度**: 命名、注释、代码组织
4. **安全检查**: SQL注入、XSS、敏感信息硬编码
5. **测试充分性**: 核心逻辑、边界条件、异常场景

---

## 审查维度详解

### 维度1: 业务逻辑正确性

**检查项**:
- [ ] 是否实现了需求分析中描述的所有功能点
- [ ] 业务规则是否正确实现（边界值、条件判断）
- [ ] 异常场景是否处理完整
- [ ] 数据流转是否符合预期

**检查方法**:
1. 读取 `需求分析.md` 中的业务规则
2. 逐条对比代码实现
3. 识别遗漏或偏差

**示例问题**:
```
❌ 需求要求"金额不能为负"，但代码中没有校验
❌ 需求要求"审批人不能是发起人"，但代码中没有判断
⚠️ 需求中提到"支持批量操作"，但只实现了单个操作
```

### 维度2: 架构一致性

**检查项**:
- [ ] 是否遵循技术方案中的核心设计
- [ ] 是否使用了方案中指定的扩展点
- [ ] 类/方法的职责是否与方案一致
- [ ] 是否引入了方案中未提及的依赖

**检查方法**:
1. 读取 `技术方案.md` 中的设计
2. 对比实际代码结构
3. 计算对齐度

**示例问题**:
```
❌ 方案要求继承 BaseFormField，但实现了独立类
❌ 方案指定使用异步调用，但实现了同步调用
⚠️ 引入了方案中未提及的第三方库
```

### 维度3: 代码规范符合度

**检查项**:
- [ ] 命名规范（类名、方法名、变量名）
- [ ] 注释规范（类注释、方法注释、复杂逻辑注释）
- [ ] 代码组织（方法长度、嵌套深度、单一职责）
- [ ] 格式规范（缩进、空行、括号）

**规范参考**:
```java
// 类命名: 大驼峰 + 后缀表意
public class AIButtonField extends BaseFormField { }

// 方法命名: 小驼峰 + 动词开头
public void handleButtonClick() { }

// 常量命名: 全大写 + 下划线分隔
private static final String DEFAULT_TIMEOUT = "30000";

// 方法长度: ≤50行
// 嵌套深度: ≤4层
// 参数个数: ≤5个
```

**示例问题**:
```
⚠️ 方法 processData 超过50行（实际78行）
⚠️ 变量命名 d 不够清晰，建议使用 document
❌ 缺少类级别的JavaDoc注释
```

### 维度4: 安全检查

**检查项**:
- [ ] SQL注入风险（参数化查询）
- [ ] XSS风险（输出编码）
- [ ] 敏感信息硬编码（API Key、密码）
- [ ] 权限校验（操作前验证）
- [ ] 日志脱敏（敏感字段不打印）

**危险模式**:
```java
// ❌ SQL注入风险
String sql = "SELECT * FROM user WHERE name = '" + name + "'";

// ✅ 安全写法
String sql = "SELECT * FROM user WHERE name = ?";
jdbcTemplate.queryForList(sql, name);

// ❌ 硬编码密钥
private static final String API_KEY = "sk-xxxxx";

// ✅ 安全写法
@Value("${ai.api.key}")
private String apiKey;

// ❌ 日志泄露敏感信息
log.info("User password: " + password);

// ✅ 安全写法
log.info("User login attempt: userId={}", userId);
```

**示例问题**:
```
❌ 发现硬编码的API密钥
❌ SQL语句存在拼接风险
⚠️ 日志中打印了用户手机号
```

### 维度5: 测试充分性

**检查项**:
- [ ] 核心逻辑是否有单元测试
- [ ] 边界条件是否测试（空值、极值、边界值）
- [ ] 异常场景是否测试（网络异常、数据异常）
- [ ] 测试覆盖率是否达标（≥70%）

**测试场景清单**:
```java
// 正常场景
@Test void should_succeed_when_valid_input() { }

// 边界场景
@Test void should_fail_when_input_is_null() { }
@Test void should_fail_when_input_is_empty() { }
@Test void should_handle_max_length_input() { }

// 异常场景
@Test void should_throw_when_service_unavailable() { }
@Test void should_retry_when_timeout() { }
```

**示例问题**:
```
❌ 核心方法 handleClick 没有单元测试
⚠️ 测试覆盖率 58%，低于70%阈值
⚠️ 缺少空值输入的测试用例
```

---

## 执行流程

```
编码完成
     ↓
┌─────────────────────────────────────┐
│ 1. 加载上下文                        │
│    - 读取需求分析.md                 │
│    - 读取技术方案.md                 │
│    - 获取修改的文件列表              │
└─────────────────────────────────────┘
     ↓
┌─────────────────────────────────────┐
│ 2. 逐维度审查                        │
│    - 业务逻辑检查                    │
│    - 架构一致性检查                  │
│    - 代码规范检查                    │
│    - 安全检查                        │
│    - 测试充分性检查                  │
└─────────────────────────────────────┘
     ↓
┌─────────────────────────────────────┐
│ 3. 汇总审查结果                      │
│    - 各维度评分                      │
│    - 问题列表                        │
│    - 修复建议                        │
└─────────────────────────────────────┘
     ↓
┌─────────────────────────────────────┐
│ 4. 决定通过/阻断                     │
│    - ❌任何一项 → 阻断               │
│    - ⚠️两项以上 → 建议修复           │
│    - ✅全部 → 通过                   │
└─────────────────────────────────────┘
```

---

## 输出格式

```
┌─────────────────────────────────────────────────────────────┐
│  🔍 AI代码专项审查报告                                       │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  审查文件: 5个                                               │
│  审查时间: 2026-02-09 11:30                                  │
│                                                              │
│  ═══ 审查结果 ═══                                           │
│                                                              │
│  维度1: 业务逻辑      ✅ 通过                                │
│  维度2: 架构一致性    ✅ 通过                                │
│  维度3: 代码规范      ⚠️ 警告 (2个问题)                      │
│  维度4: 安全检查      ✅ 通过                                │
│  维度5: 测试充分性    ⚠️ 警告 (1个问题)                      │
│                                                              │
│  ═══ 问题详情 ═══                                           │
│                                                              │
│  ⚠️ [代码规范] AIButtonHandler.java:45                      │
│     方法 processClick 超过50行 (实际62行)                   │
│     建议: 拆分为多个私有方法                                │
│                                                              │
│  ⚠️ [代码规范] AIButtonField.java:12                        │
│     缺少类级别JavaDoc注释                                   │
│     建议: 添加类说明和作者信息                              │
│                                                              │
│  ⚠️ [测试充分性] AIButtonHandlerTest.java                   │
│     测试覆盖率 65%，低于70%阈值                             │
│     建议: 增加边界条件测试用例                              │
│                                                              │
│  ═══ 综合结论 ═══                                           │
│                                                              │
│  状态: ⚠️ 建议修复                                          │
│  原因: 2个维度存在警告                                      │
│  建议: 修复后可继续，不阻断流程                             │
│                                                              │
│  [查看详情] [忽略继续] [修复后重审]                         │
└─────────────────────────────────────────────────────────────┘
```

---

## 阻断规则

### 红色 ❌ (阻断)
任何一项为红色，必须修复后才能继续：
- 业务逻辑错误（功能未实现或实现错误）
- 严重安全漏洞（SQL注入、硬编码密钥）
- 架构严重偏离（完全不符合技术方案）

### 黄色 ⚠️ (警告)
两项以上为黄色，建议修复：
- 代码规范问题
- 测试覆盖率不足
- 轻微架构偏差

### 绿色 ✅ (通过)
全部绿色，审查通过：
- 所有维度都符合标准
- 可以继续下一阶段

---

## 使用方式

### 自动触发

在 `dev-impl-test` 或 `dev-quick-impl` 完成编码后自动触发：

```
编码完成
     ↓
自动调用 /dev-ai-review
     ↓
审查通过 → 继续质量门禁
审查阻断 → 修复后重审
```

### 手动触发

```
/dev-ai-review
```

对当前需求的代码进行专项审查。

---

## 与其他skill的协作

| Skill | 协作方式 |
|-------|----------|
| dev-context-loader | 读取需求分析和技术方案 |
| dev-impl-test | 编码完成后触发审查 |
| dev-quick-impl | 编码完成后触发审查 |
| dev-quality-gate | 审查结果作为门禁指标之一 |

---

## 审查报告存档

审查结果记录在 `.progress.json`:

```json
{
  "stages": [
    {
      "stage": 4,
      "name": "编码+测试",
      "aiReview": {
        "reviewedAt": "2026-02-09T11:30:00",
        "result": "warning",
        "dimensions": {
          "businessLogic": "pass",
          "architecture": "pass",
          "codeStyle": "warning",
          "security": "pass",
          "testCoverage": "warning"
        },
        "issues": [
          {
            "dimension": "codeStyle",
            "file": "AIButtonHandler.java",
            "line": 45,
            "message": "方法超过50行",
            "severity": "warning"
          }
        ]
      }
    }
  ]
}
```
