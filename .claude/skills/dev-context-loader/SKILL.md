---
name: dev-context-loader
description: 上下文自动加载器。自动读取当前需求的进度文件、已完成阶段产物和关键决策，为后续阶段提供完整上下文。
---

# 上下文加载器 (Context Loader)

> 自动加载当前需求的完整上下文，确保阶段间信息无缝传递

---

## 核心职责

1. **读取进度文件**: 加载 `.progress.json`
2. **收集阶段产物**: 读取已完成阶段的产出文档
3. **提取关键决策**: 从 `decisions[]` 中提取重要决策
4. **格式化输出**: 生成结构化的上下文摘要

---

## 执行流程

```
调用上下文加载器
     ↓
┌─────────────────────────────────────┐
│ 1. 定位需求目录                      │
│    - 查找 docs/需求记录/[当前需求]/   │
│    - 读取 .progress.json             │
└─────────────────────────────────────┘
     ↓
┌─────────────────────────────────────┐
│ 2. 解析进度信息                      │
│    - 需求名称和ID                    │
│    - 任务级别 (L1/L2/L3)             │
│    - 当前阶段                        │
│    - 流程模板                        │
└─────────────────────────────────────┘
     ↓
┌─────────────────────────────────────┐
│ 3. 收集已完成阶段产物                │
│    - 需求分析.md (如已完成)          │
│    - 技术方案.md (如已完成)          │
│    - 编码计划.md (如已完成)          │
│    - 其他阶段产物                    │
└─────────────────────────────────────┘
     ↓
┌─────────────────────────────────────┐
│ 4. 提取关键决策                      │
│    - 技术选型决策                    │
│    - 架构决策                        │
│    - 实现方案决策                    │
└─────────────────────────────────────┘
     ↓
┌─────────────────────────────────────┐
│ 5. 格式化输出                        │
│    - 上下文摘要                      │
│    - 关键信息高亮                    │
│    - 决策列表                        │
└─────────────────────────────────────┘
```

---

## 输出格式

```markdown
## 📋 当前需求上下文

### 基本信息
- **需求**: [需求名称] (ID: REQ-2026-XXX)
- **级别**: L2 (中等任务)
- **当前阶段**: 3/5 编码计划
- **流程**: L2_MEDIUM

### 已完成阶段
| 阶段 | 名称 | 完成时间 | 产物 |
|------|------|----------|------|
| 1 | 需求分析 | 10:15 | 需求分析.md |
| 2 | 技术分析+方案 | 10:45 | 技术方案.md |

### 上阶段产物摘要

#### 需求分析要点
- 核心需求: [摘要]
- 涉及模块: [模块列表]
- 业务规则: [规则列表]

#### 技术方案要点
- 核心思路: [摘要]
- 扩展点: [扩展点列表]
- 数据模型: [模型概要]

### 关键决策
| 决策 | 选择 | 原因 |
|------|------|------|
| 架构模式 | 继承BaseFormField | 复用现有字段体系 |
| AI调用方式 | 异步回调 | 避免阻塞表单渲染 |

### 注意事项
- [从notes中提取的注意事项]
```

---

## 产物定位规则

根据 `flowTemplate.type` 确定可能的产物：

### L1_SIMPLE 流程产物
| 阶段 | 产物 |
|------|------|
| quick-analysis | (无独立产物) |
| quick-impl | (代码文件) |
| quick-finish | 需求总结.md |

### L2_MEDIUM 流程产物
| 阶段 | 产物 |
|------|------|
| requirement | 需求分析.md |
| tech-combined | 技术方案.md |
| coding-plan | 编码计划.md |
| impl-test | (代码文件) |
| finish | 需求总结.md |

### L3_COMPLEX 流程产物
| 阶段 | 产物 |
|------|------|
| requirement | 需求分析.md |
| tech-analysis | 技术分析.md |
| tech-spec | 技术方案.md |
| coding-plan | 编码计划.md |
| coding | (代码文件) |
| unit-test | (测试文件) |
| alignment | 对齐报告.md |
| documentation | 需求总结.md |

---

## 摘要提取规则

### 需求分析.md 摘要
提取以下章节的核心内容：
- `## 核心需求` → 1-2句话摘要
- `## 涉及模块` → 模块列表
- `## 业务规则` → 规则列表

### 技术方案.md 摘要
提取以下章节的核心内容：
- `## 核心思路` 或 `### 2.1 核心思路` → 1-2句话摘要
- `## 扩展点` 或 `### 1.2 扩展点` → 扩展点列表
- `## 数据模型` 或 `### 2.3 数据模型` → 字段列表

### 编码计划.md 摘要
提取以下章节的核心内容：
- `## 任务列表` → 任务概要
- `## 实现顺序` → 顺序依赖

---

## 使用方式

### 在阶段skill中引用

所有阶段skill应在开头包含上下文加载：

```markdown
## 执行协议

### 步骤0: 加载上下文 (自动)

在开始本阶段工作前，自动执行上下文加载：

1. 读取 `docs/需求记录/[当前需求]/.progress.json`
2. 根据 `currentStage` 确定需要的上下文
3. 读取所有已完成阶段的产物
4. 提取关键决策点
5. 在内存中保持上下文，供后续步骤使用

### 步骤1: [正式开始本阶段工作]
...
```

### 手动调用

```
/dev-context-loader
```

输出当前需求的完整上下文摘要。

---

## 上下文注入示例

### 进入"编码计划"阶段时

```
AI 自动加载上下文:

📋 当前需求上下文
─────────────────────────────────────────────────────

需求: 为表单引擎添加AI按钮字段 (REQ-2026-001)
级别: L2 (中等任务)
当前阶段: 3/5 编码计划

已完成阶段:
✅ 阶段1: 需求分析     - 完成于 10:15
✅ 阶段2: 技术分析+方案 - 完成于 10:45

上阶段产物摘要:

【需求分析要点】
- 核心需求: 创建可触发AI技能的按钮字段
- 涉及模块: 表单引擎(高), AI能力中心(中)
- 业务规则: 点击触发AI调用，异步返回结果

【技术方案要点】
- 核心思路: 继承BaseFormField，通过AIBridge调用
- 扩展点: AIButtonField, AIButtonHandler, AIButtonConverter
- 数据模型: agentId, skillId, inputMapping, outputMapping

关键决策:
├── AI调用方式: 异步回调 (避免阻塞)
└── 结果展示: 弹窗 + 字段回填

─────────────────────────────────────────────────────

现在开始编码计划阶段...
```

---

## 错误处理

### 找不到进度文件
```
⚠️ 未找到进行中的需求

当前没有进行中的开发任务。

使用 /dev-start [需求描述] 开始新需求。
```

### 产物文件缺失
```
⚠️ 部分产物缺失

阶段1 (需求分析) 标记为已完成，但未找到 需求分析.md

可能原因:
- 文件被移动或删除
- 阶段状态标记错误

建议: 检查 docs/需求记录/[需求名]/ 目录
```

---

## 与其他skill的集成

| Skill | 集成方式 |
|-------|----------|
| dev-requirement | 阶段完成后，产物被后续阶段引用 |
| dev-tech-combined | 读取需求分析摘要，输出技术方案 |
| dev-coding-plan | 读取技术方案摘要，输出编码计划 |
| dev-impl-test | 读取编码计划，按任务实现 |
| dev-finish | 读取所有产物，生成完成报告 |
| dev-ai-review | 读取技术方案，对比实现一致性 |
| dev-quality-gate | 读取方案，检查对齐度 |

---

## 最佳实践

1. **每个阶段开始时自动加载**: 确保不遗漏上下文
2. **摘要而非全文**: 提取关键信息，避免上下文溢出
3. **决策透明化**: 所有重要决策都应记录在 `.progress.json`
4. **产物规范化**: 使用统一的章节结构，便于自动提取
