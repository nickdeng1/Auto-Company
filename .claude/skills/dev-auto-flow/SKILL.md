---
name: dev-auto-flow
description: L3自动流转控制器。实现全流程自动执行，仅在异常时暂停，支持断点恢复。
---

# 自动流转控制器 (Auto Flow Controller)

> L3自主模式核心：全流程自动执行，质量门禁自动检查，异常自动暂停

---

## 核心职责

1. **自动执行流程**: 无需人工干预，自动执行各阶段
2. **质量门禁检查**: 每阶段自动执行质量门禁
3. **异常暂停通知**: 遇到问题自动暂停并通知
4. **断点恢复**: 支持从暂停点继续执行

---

## 执行流程

```
/dev-start --l3-auto 需求描述
     ↓
┌─────────────────────────────────────┐
│ 1. 初始化自主流程                    │
│    - 创建需求目录                    │
│    - 生成 .progress.json             │
│    - 加载 L3_AUTO 流程模板           │
│    - 设置 autoFlow: true             │
└─────────────────────────────────────┘
     ↓
┌─────────────────────────────────────┐
│ 2. 自动执行循环                      │
│                                      │
│    while (hasNextStage) {            │
│      ┌─────────────────────────────┐ │
│      │ 2.1 加载上下文               │ │
│      │     - dev-context-loader     │ │
│      └─────────────────────────────┘ │
│                ↓                     │
│      ┌─────────────────────────────┐ │
│      │ 2.2 执行当前阶段             │ │
│      │     - 调用阶段skill          │ │
│      │     - 记录执行结果           │ │
│      └─────────────────────────────┘ │
│                ↓                     │
│      ┌─────────────────────────────┐ │
│      │ 2.3 AI代码审查 (编码阶段)    │ │
│      │     - dev-ai-review          │ │
│      │     - 检查是否阻断           │ │
│      └─────────────────────────────┘ │
│                ↓                     │
│      ┌─────────────────────────────┐ │
│      │ 2.4 质量门禁检查             │ │
│      │     - dev-quality-gate       │ │
│      │     - 检查是否通过           │ │
│      └─────────────────────────────┘ │
│                ↓                     │
│      ┌─────────────────────────────┐ │
│      │ 2.5 判断是否继续             │ │
│      │     - 通过 → 自动下一阶段    │ │
│      │     - 失败 → 暂停并通知      │ │
│      └─────────────────────────────┘ │
│    }                                 │
│                                      │
└─────────────────────────────────────┘
     ↓
┌─────────────────────────────────────┐
│ 3. 完成或暂停                        │
│    - 完成: 生成最终报告              │
│    - 暂停: 保存状态，等待恢复        │
└─────────────────────────────────────┘
```

---

## 暂停条件

自动流转会在以下情况暂停：

| 条件 | 说明 | 恢复方式 |
|------|------|----------|
| `qualityGateFailed` | 质量门禁不通过 (分数<60) | 修复问题后 `/dev-resume` |
| `aiReviewRed` | AI审查有红色项 | 修复问题后 `/dev-resume` |
| `compileFailed` | 编译失败 | 修复错误后 `/dev-resume` |
| `testFailed` | 测试失败 | 修复测试后 `/dev-resume` |
| `userInterrupt` | 用户手动中断 | `/dev-resume` 继续 |

---

## 自动执行日志

自动执行过程中实时输出日志：

```
┌─────────────────────────────────────────────────────────────┐
│  🤖 L3 自主模式执行中                                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  需求: 重构流程引擎任务调度核心                              │
│  流程: L3_AUTO (8阶段/自动质量门禁)                         │
│  开始时间: 2026-02-09 10:00                                  │
│                                                              │
│  ═══ 执行进度 ═══                                           │
│                                                              │
│  ✅ 阶段1: 需求分析     [10:00 - 10:15]  15分钟              │
│     └── 产物: 需求分析.md                                   │
│                                                              │
│  ✅ 阶段2: 技术分析     [10:15 - 10:30]  15分钟              │
│     ├── 产物: 技术分析.md                                   │
│     └── 质量门禁: 85分 ✅                                   │
│                                                              │
│  ✅ 阶段3: 技术方案     [10:30 - 11:00]  30分钟              │
│     ├── 产物: 技术方案.md                                   │
│     └── 质量门禁: 90分 ✅                                   │
│                                                              │
│  ✅ 阶段4: 编码计划     [11:00 - 11:15]  15分钟              │
│     ├── 产物: 编码计划.md                                   │
│     └── 质量门禁: 88分 ✅                                   │
│                                                              │
│  🔄 阶段5: 编码实现     [11:15 - 进行中]                     │
│     └── 正在执行任务 3/8...                                 │
│                                                              │
│  ⏳ 阶段6: 单元测试     待执行                               │
│  ⏳ 阶段7: 方案对齐     待执行                               │
│  ⏳ 阶段8: 文档生成     待执行                               │
│                                                              │
│  ═══ 效能统计 ═══                                           │
│                                                              │
│  已耗时: 1小时15分钟                                        │
│  预估剩余: ~45分钟                                          │
│  质量门禁: 4/4 通过                                         │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 暂停通知

当自动执行暂停时，输出详细的暂停信息：

```
┌─────────────────────────────────────────────────────────────┐
│  ⏸ L3 自主模式已暂停                                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  暂停原因: 质量门禁不通过                                   │
│  暂停阶段: 5/8 编码实现                                     │
│  暂停时间: 2026-02-09 12:30                                  │
│                                                              │
│  ═══ 问题详情 ═══                                           │
│                                                              │
│  质量门禁得分: 55/100 (需要≥60)                             │
│                                                              │
│  ❌ 测试覆盖率: 45% (需要≥70%)                              │
│     └── 缺少 TaskScheduler 的单元测试                       │
│                                                              │
│  ❌ AI审查: 有1个红色项                                     │
│     └── TaskDispatcher.java:78 存在SQL注入风险              │
│                                                              │
│  ═══ 修复建议 ═══                                           │
│                                                              │
│  1. 为 TaskScheduler 添加单元测试                           │
│  2. 修复 TaskDispatcher.java:78 的SQL注入问题               │
│  3. 重新运行测试确保覆盖率≥70%                              │
│                                                              │
│  ═══ 恢复方式 ═══                                           │
│                                                              │
│  修复以上问题后，执行: /dev-resume                          │
│                                                              │
│  [查看详情] [手动修复] [放弃自主模式]                       │
└─────────────────────────────────────────────────────────────┘
```

---

## 完成报告

自动执行完成后，输出完整报告：

```
┌─────────────────────────────────────────────────────────────┐
│  🎉 L3 自主模式完成                                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  需求: 重构流程引擎任务调度核心                              │
│  流程: L3_AUTO (8阶段)                                      │
│  状态: 全流程自动完成 ✅                                    │
│                                                              │
│  ═══ 效能统计 ═══                                           │
│                                                              │
│  总耗时: 2小时30分钟                                        │
│  阶段完成: 8/8                                               │
│  质量门禁: 7/7 通过                                         │
│  暂停次数: 1次 (已自动恢复)                                 │
│  人工干预: 0次                                               │
│                                                              │
│  ═══ 代码统计 ═══                                           │
│                                                              │
│  修改文件: 23个                                              │
│  代码行数: +1,250 / -380                                    │
│  测试覆盖率: 78%                                            │
│  AI贡献率: 85%                                               │
│                                                              │
│  ═══ 产物清单 ═══                                           │
│                                                              │
│  - docs/需求记录/重构流程引擎任务调度核心/                   │
│    ├── 需求分析.md                                          │
│    ├── 技术分析.md                                          │
│    ├── 技术方案.md                                          │
│    ├── 编码计划.md                                          │
│    ├── 对齐报告.md                                          │
│    └── 需求总结.md                                          │
│                                                              │
│  ═══ 下一步 ═══                                             │
│                                                              │
│  人工最终验收:                                               │
│  1. 检查代码实现是否符合预期                                │
│  2. 验证功能正确性                                          │
│  3. 确认文档完整性                                          │
│                                                              │
│  [验收通过] [需要修改] [查看产物]                           │
└─────────────────────────────────────────────────────────────┘
```

---

## 使用方式

### 启动L3自主模式

```
/dev-start --l3-auto 需求描述
```

### 恢复暂停的自主模式

```
/dev-resume
```

### 查看自主模式进度

```
/dev-status
```

### 手动中断自主模式

```
/dev-pause
```

---

## 进度文件扩展

L3自主模式的 `.progress.json` 包含额外字段：

```json
{
  "requirementId": "REQ-2026-003",
  "requirementName": "重构流程引擎任务调度核心",
  "taskGrade": {
    "level": "L3",
    "score": 14
  },
  "flowTemplate": {
    "type": "L3_AUTO",
    "autoFlow": true
  },
  "autoFlowState": {
    "status": "running",
    "startedAt": "2026-02-09T10:00:00",
    "currentStage": 5,
    "pauseHistory": [
      {
        "stage": 5,
        "reason": "qualityGateFailed",
        "pausedAt": "2026-02-09T12:30:00",
        "resumedAt": "2026-02-09T12:45:00"
      }
    ],
    "qualityGateResults": [
      { "stage": 2, "score": 85, "result": "pass" },
      { "stage": 3, "score": 90, "result": "pass" },
      { "stage": 4, "score": 88, "result": "pass" }
    ],
    "checkpoints": [
      {
        "stage": 4,
        "savedAt": "2026-02-09T11:15:00",
        "artifacts": ["需求分析.md", "技术分析.md", "技术方案.md", "编码计划.md"]
      }
    ]
  },
  "metrics": {
    "totalDuration": null,
    "autoFlowMetrics": {
      "pauseCount": 1,
      "retryCount": 0,
      "humanInterventions": 0
    }
  }
}
```

---

## 与其他skill的协作

| Skill | 协作方式 |
|-------|----------|
| dev-start | `--l3-auto` 参数启动自主模式 |
| dev-context-loader | 每阶段自动加载上下文 |
| dev-ai-review | 编码阶段自动触发 |
| dev-quality-gate | 每阶段自动执行门禁 |
| dev-status | 显示自主模式进度 |

---

## 配置选项

在 `L3-auto.json` 中配置：

```json
{
  "autoFlowConfig": {
    "maxRetries": 2,
    "retryDelay": 5000,
    "timeout": 1800000,
    "notifyOnPause": true,
    "notifyOnComplete": true,
    "saveCheckpoints": true
  }
}
```

| 选项 | 说明 | 默认值 |
|------|------|--------|
| maxRetries | 单阶段最大重试次数 | 2 |
| retryDelay | 重试间隔(ms) | 5000 |
| timeout | 单阶段超时(ms) | 1800000 |
| notifyOnPause | 暂停时通知 | true |
| notifyOnComplete | 完成时通知 | true |
| saveCheckpoints | 保存检查点 | true |

---

## 最佳实践

1. **适用场景**: L3-AUTO 适合确定性高、模式成熟的任务
2. **监控执行**: 即使自动执行，也建议定期检查进度
3. **及时恢复**: 暂停后尽快修复问题并恢复
4. **最终验收**: 自动完成后仍需人工最终验收
